# 実装計画

- [x] 1. プロジェクト基盤の準備とセットアップ
- [x] 1.1 必要な依存関係の追加
  - pyproject.tomlにpython-multipart依存関係を追加
  - ファイルアップロード処理に必要なライブラリを設定
  - 既存の依存関係との互換性を確認
  - _要件: 1.1, 7.4_

- [x] 1.2 開発環境の更新
  - 新しい依存関係でのuv syncの実行と確認
  - ローカル環境での動作確認
  - CI/CDパイプラインが依然として正常に動作することを確認
  - _要件: 7.3_

- [x] 2. ファイルアップロード機能の実装
- [x] 2.1 multipart/form-dataファイル受信機能
  - api.pyに/uploadエンドポイントを追加
  - FastAPI UploadFileを使用したファイル受信処理を実装
  - フォームデータ（type、gpu フラグ）の解析機能を実装
  - HTTPSレスポンスの基本構造を設定
  - _要件: 1.1, 1.5_

- [x] 2.2 ファイル検証とバリデーション機能
  - ファイル拡張子（.jsonl）の検証ロジックを実装
  - ファイルサイズ制限（100MB）のチェック機能を実装
  - JSONLファイルの基本構造検証を実装
  - 不正ファイル時の適切なエラーレスポンス（400, 413）を実装
  - _要件: 1.2, 1.3, 5.1_

- [x] 2.3 一時ファイル管理システム
  - システム一時ディレクトリでのファイル保存機能を実装
  - 一意なファイル名生成（UUID使用）を実装
  - 処理完了後の自動ファイル削除機能を実装
  - エラー時のクリーンアップ機能を実装
  - _要件: 1.4, 5.2, 5.3_

- [x] 3. 既存処理との統合と同期実行
- [x] 3.1 process_jsonl_file関数との統合
  - __main__.pyからのprocess_jsonl_file関数インポート
  - 一時ファイルパスを使用した関数呼び出し
  - GPU使用フラグの適切な処理
  - 既存の類似度計算ロジックとの完全な互換性確保
  - _要件: 3.1, 7.2_

- [x] 3.2 同期処理とタイムアウト管理
  - 30秒処理タイムアウトの実装
  - HTTPコネクション維持機能
  - 長時間処理における適切なレスポンス管理
  - タイムアウト時のエラーレスポンス（504）実装
  - _要件: 3.2, 3.5_

- [x] 4. Web UIとフォームインターフェース
- [x] 4.1 HTMLフォームページの実装
  - /uiエンドポイントの追加
  - ファイルアップロード用HTMLフォームの作成
  - .jsonl ファイルのみ選択可能なファイルダイアログ設定
  - 出力形式選択（score/file）機能の実装
  - _要件: 2.1, 2.2, 2.4_

- [x] 4.2 ユーザーインタラクション機能
  - GPU使用チェックボックスの実装
  - ファイルアップロード・処理中のローディング表示
  - JavaScriptによるフォーム送信とプログレス表示
  - レスポンシブデザインでの使いやすいUI
  - _要件: 2.3, 2.5_

- [x] 5. 結果処理とダウンロード機能
- [x] 5.1 JSON結果処理と返却
  - 計算結果のJSON形式での返却機能
  - 適切なContent-Typeヘッダー（application/json）設定
  - 結果データの構造化とフォーマット
  - ブラウザでの結果表示機能
  - _要件: 4.1, 4.2_

- [x] 5.2 CSV変換とエクスポート機能
  - JSON結果からCSV形式への変換ロジック実装
  - 適切なContent-Typeヘッダー（text/csv）設定
  - Content-Dispositionヘッダーでのファイル名設定
  - 処理日時を含むファイル名の生成
  - _要件: 4.3, 4.4, 4.5_

- [x] 6. エラーハンドリングとログシステム
- [x] 6.1 包括的エラーハンドリング
  - JSONLファイル内無効行の自動修復機能
  - inference1/inference2フィールド欠落時の詳細エラー報告
  - 具体的な行番号とエラー内容を含むレスポンス
  - サーバーリソース不足時の適切なエラー処理（503）
  - _要件: 6.1, 6.2, 6.3_

- [x] 6.2 システムエラーとリカバリ機能
  - 予期しないエラー時のエラーID生成機能
  - ユーザー向けの分かりやすいエラーメッセージ
  - 次のアクション提案機能の実装
  - ディスク容量不足時の適切な処理（507）
  - _要件: 6.4, 6.5, 5.5_

- [x] 6.3 ログシステムの実装
  - アップロードログ（タイムスタンプ、ファイルサイズ、処理時間）の記録
  - システムメトリクスの追跡機能
  - エラーログの詳細記録
  - ログローテーションとクリーンアップ機能
  - _要件: 5.4_

- [x] 7. 単一ファイル比較APIエンドポイントの整理
- [x] 7.1 エンドポイントのリネーム
  - /upload エンドポイントを /api/compare/single にリネーム
  - /api/compare/dual と一貫性のあるAPI構造を実現
  - Web UIのフォーム送信先URLを更新
  - _要件: 1.1, 7.2_

- [ ] 7.2 既存テストの更新
  - /upload を参照している既存テストを /api/compare/single に更新
  - Playwright E2Eテストのエンドポイント更新
  - テストケースが正常に動作することを確認
  - _要件: 全要件のテスト網羅_

- [ ] 7.3 ドキュメントとコメントの更新
  - API仕様ドキュメントの更新
  - コード内のコメントと説明の更新
  - README.mdのAPI使用例の更新
  - _要件: 7.1, 7.4_

- [-] 8. テストの実装（既存）
- [x] 8.1 ユニットテストの作成
  - ファイル検証関数のテスト
  - CSV変換機能のテスト ✅ (test_csv_export.py)
  - エラーレスポンス生成のテスト
  - 一時ファイル管理機能のテスト
  - _要件: 全要件のテスト網羅_

- [x] 8.2 統合テストの実装
  - ファイルアップロードから結果取得までのE2Eテスト ✅ (Playwright実装)
  - 各種エラーシナリオのテスト ✅ (test_ui_playwright.py)
  - 大容量ファイル処理のテスト
  - GPU/CPUモード切り替えのテスト ✅ (test_upload_playwright.py)
  - _要件: 全要件の統合テスト_

- [x] 9. 統合と最終確認
- [x] 9.1 システム全体の統合テスト
  - 既存CLI機能への影響がないことの確認
  - Web UI とCLI両方での動作確認
  - 全エンドポイント間の相互作用テスト
  - パフォーマンス要件の確認
  - _要件: 7.3, 全要件の総合確認_

- [x] 9.2 本番環境準備
  - セキュリティヘッダーの設定確認
  - ログ設定の最終確認
  - エラーハンドリングの網羅性確認
  - ドキュメント更新（README.mdのAPI使用法追加）
  - _要件: セキュリティ要件と運用要件_