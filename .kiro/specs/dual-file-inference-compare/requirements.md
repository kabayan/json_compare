# Requirements Document

## 概要
本機能は、2つの異なるJSONLファイルから`inference`列を抽出し、それらを比較して類似度を計算するツールです。異なるモデルやバージョンの出力結果を定量的に評価することで、機械学習モデルの品質管理と改善を支援します。CLIコマンド、Web UI、REST APIの3つのインターフェースから利用可能とし、開発者とデータサイエンティストの多様なユースケースに対応します。

## Requirements

### Requirement 1: ファイル入力と検証
**目的:** データサイエンティストとして、2つのJSONLファイルを指定して比較処理を実行したいため、システムが確実にファイルを受け取り検証する必要がある

#### 受入基準

1. WHEN ユーザーが2つのJSONLファイルパスを指定する THEN 比較システム SHALL 両方のファイルの存在を確認する
2. IF いずれかのファイルが存在しない THEN 比較システム SHALL エラーメッセージと共に処理を中断する
3. WHEN ファイルが読み込まれる THEN 比較システム SHALL ファイルが有効なJSONL形式であることを検証する
4. IF ファイルにinference列が存在しない THEN 比較システム SHALL 具体的なエラーメッセージを表示する
5. WHERE ファイルサイズが100MBを超える場合 THE 比較システム SHALL 警告を表示して処理継続の確認を求める

### Requirement 2: Inference列の抽出と中間ファイル生成
**目的:** 開発者として、既存の比較機能を活用するため、2つのファイルからinference列を抽出した中間ファイルを生成したい

#### 受入基準

1. WHEN 2つの入力ファイルが検証された THEN 比較システム SHALL 各ファイルからinference列を抽出する
2. WHEN inference列が抽出される THEN 比較システム SHALL inference1とinference2として中間JSONLファイルに結合する
3. IF 2つのファイルの行数が異なる THEN 比較システム SHALL 共通の行数まで処理するか全行処理するかのオプションを提供する
4. WHILE 中間ファイルを生成中 THE 比較システム SHALL 進捗状況を表示する
5. WHEN 中間ファイル生成が完了する THEN 比較システム SHALL 一時ファイルのパスを内部的に保持する

### Requirement 3: CLIインターフェース
**目的:** コマンドラインユーザーとして、ターミナルから直接2つのファイルを比較し、結果を取得したい

#### 受入基準

1. WHEN ユーザーがCLIコマンドを実行する THEN 比較システム SHALL `json_compare --dual-file file1.jsonl file2.jsonl` 形式のコマンドを受け付ける
2. WHEN --type オプションが指定される THEN 比較システム SHALL score または file 形式で結果を出力する
3. IF --output オプションが指定される THEN 比較システム SHALL 結果を指定ファイルに保存する
4. WHEN --gpu オプションが指定される THEN 比較システム SHALL GPU処理モードで実行する
5. WHERE --mapping オプションが指定される場合 THE 比較システム SHALL 行番号の対応関係を指定するCSVファイルを読み込む
6. WHEN CLIコマンドでエラーが発生する THEN 比較システム SHALL 適切なエラーコードと共に終了する

### Requirement 4: Web UIインターフェース
**目的:** 非技術ユーザーとして、ブラウザから簡単に2つのファイルをアップロードして比較結果を確認したい

#### 受入基準

1. WHEN ユーザーがWeb UIにアクセスする THEN 比較システム SHALL 2つのファイルアップロードフィールドを表示する
2. WHEN ユーザーが2つのファイルを選択する THEN 比較システム SHALL ドラッグ&ドロップまたはファイル選択ダイアログを提供する
3. WHILE ファイル処理中 THE 比較システム SHALL プログレスバーと処理状況を表示する
4. WHEN 処理が完了する THEN 比較システム SHALL 結果をビジュアル表示し、JSON/CSV形式でダウンロード可能にする
5. IF ユーザーがオプション設定を変更する THEN 比較システム SHALL GPU使用、出力形式、行マッピング方式の選択肢を提供する
6. WHERE エラーが発生した場合 THE 比較システム SHALL ユーザーフレンドリーなエラーメッセージと対処法を表示する

### Requirement 5: REST APIインターフェース
**目的:** システム統合開発者として、プログラムから2つのファイルを比較し、構造化された結果を取得したい

#### 受入基準

1. WHEN APIエンドポイント `/api/compare/dual` にPOSTリクエストが送信される THEN 比較システム SHALL multipart/form-dataで2つのファイルを受け付ける
2. WHEN APIリクエストが処理される THEN 比較システム SHALL JSONレスポンスで結果を返す
3. IF 処理に時間がかかる場合 THEN 比較システム SHALL ジョブIDを返して非同期処理をサポートする
4. WHEN ジョブステータスが照会される THEN 比較システム SHALL `/api/jobs/{job_id}` で進捗と結果を返す
5. WHERE APIレート制限が必要な場合 THE 比較システム SHALL 適切なHTTPステータスコード（429）を返す
6. WHEN APIエラーが発生する THEN 比較システム SHALL RESTful規約に従ったエラーレスポンスを返す

### Requirement 6: 比較処理と結果出力
**目的:** データサイエンティストとして、2つのファイルの比較結果を定量的に評価し、分析に活用したい

#### 受入基準

1. WHEN 中間ファイルが生成される THEN 比較システム SHALL 既存のprocess_jsonl_file関数を使用して類似度計算を実行する
2. WHEN score形式が選択される THEN 比較システム SHALL 全体の類似度スコア、統計情報、評価カテゴリを出力する
3. WHEN file形式が選択される THEN 比較システム SHALL 各行の詳細比較結果をリスト形式で出力する
4. IF 行マッピングが指定される THEN 比較システム SHALL 元のファイルの行番号を結果に含める
5. WHERE 比較不能な行が存在する場合 THE 比較システム SHALL スキップした行の情報を結果に含める
6. WHEN 結果が生成される THEN 比較システム SHALL 処理時間、ファイル名、使用モードをメタデータとして含める

### Requirement 7: エラー処理とロギング
**目的:** システム管理者として、問題発生時に迅速に原因を特定し、システムの安定性を維持したい

#### 受入基準

1. WHEN システムエラーが発生する THEN 比較システム SHALL エラーIDを生成して詳細をログに記録する
2. IF JSONLファイルに修復可能な問題がある THEN 比較システム SHALL 自動修復を試みて警告を表示する
3. WHILE 処理実行中 THE 比較システム SHALL アクセスログ、エラーログ、メトリクスログを分離して記録する
4. WHERE メモリやディスク不足が検出される場合 THE 比較システム SHALL 事前チェックを実行して警告を表示する
5. WHEN 処理が中断される THEN 比較システム SHALL 生成した一時ファイルを自動的にクリーンアップする