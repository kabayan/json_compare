# 実装計画

## 実装タスクリスト

- [ ] 1. LLMテンプレート管理基盤の構築
- [x] 1.1 プロンプトテンプレート読み込みシステムの実装
  - YAMLファイルからプロンプトテンプレートを読み込む機能を実装
  - テンプレート内の変数置換メカニズムを構築
  - プロンプトファイルの形式バリデーション機能を追加
  - デフォルトプロンプトテンプレートの作成と配置
  - _Requirements: 2.1, 2.2, 2.4, 2.5_

- [x] 1.2 プロンプト管理システムの確立
  - プロンプトファイルのディレクトリ構造を定義
  - システムプロンプトとユーザープロンプトの分離管理
  - カスタムプロンプトテンプレートのサポート機能
  - プロンプトファイル不在時のエラーハンドリング
  - _Requirements: 2.1, 2.3_

- [ ] 2. vLLM API通信機能の実装
- [x] 2.1 HTTPクライアント基盤の構築
  - vLLM APIエンドポイントへの非同期HTTP通信機能を実装
  - 認証ヘッダーとリクエストフォーマット処理を追加
  - 環境変数によるAPIエンドポイント設定機能を構築
  - API接続のヘルスチェック機能を実装
  - _Requirements: 1.3, 3.5, 6.1_

- [x] 2.2 APIレスポンス処理とエラー管理
  - APIレスポンスのパースと検証処理を実装
  - タイムアウト処理とプログレスバー表示機能を追加
  - 接続エラー時のリトライメカニズムを構築
  - レート制限エラーへの指数バックオフ対応を実装
  - _Requirements: 1.4, 1.5, 6.2, 6.3, 6.4_

- [ ] 3. LLMベース類似度判定コア機能の実装
- [x] 3.1 類似度計算エンジンの構築
  - LLMを使用した類似度判定のメインロジックを実装
  - 比較対象テキストのプロンプトへの埋め込み処理を構築
  - モデル選択とパラメータ設定機能を実装
  - 大量ファイル処理での順次実行メカニズムを構築
  - _Requirements: 1.1, 3.1, 3.2, 3.3, 3.4, 6.5_

- [x] 3.2 スコア変換と結果処理システムの実装
  - LLM応答から数値スコアを抽出する機能を実装
  - カテゴリベースのスコア推定ロジックを構築
  - 解析不能な応答への対処メカニズムを実装
  - スコア範囲の検証と自動クランプ機能を追加
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 8.5_

- [ ] 4. 戦略パターンとシステム統合の実装
- [x] 4.1 類似度計算戦略の切り替えシステム
  - 埋め込みモードとLLMモードの動的切り替え機能を実装
  - 既存の類似度計算システムとの統合を実現
  - フォールバック機能と自動切り替えロジックを構築
  - 戦略選択のためのインターフェース統一を実装
  - _Requirements: 1.1, 1.2, 1.4, 6.3_

- [x] 4.2 比較方法識別とメタデータ拡張機能
  - 使用した判定方式の明示的識別機能を実装
  - LLM固有メタデータの出力結果への付与を実装
  - 埋め込み固有メタデータの出力結果への付与を実装
  - 既存の出力フォーマットとの後方互換性を維持
  - _Requirements: 8.1, 8.3, 8.4, 6.1_

- [x] 5. CLIインターフェースの拡張
- [x] 5.1 コマンドラインオプションの追加
  - LLMモード有効化フラグを実装
  - プロンプトファイル指定オプションを追加
  - モデル選択と生成パラメータのオプションを実装
  - デュアルファイル比較でのLLMサポートを追加
  - _Requirements: 1.1, 2.2, 3.2, 5.4_

- [x] 5.2 CLIヘルプとエラーメッセージの拡張
  - 新規オプションのヘルプメッセージを追加
  - LLM関連エラーの詳細表示機能を実装
  - フォールバック提案メッセージを実装
  - 使用例とベストプラクティスの表示機能を追加
  - _Requirements: 1.4, 2.3_

- [x] 6. Web UIへのLLM機能統合
- [x] 6.1 フロントエンドUIコンポーネントの追加
  - LLMベース判定使用チェックボックスを実装
  - プロンプトファイル選択インターフェースを構築
  - LLMモード時の追加設定フォームを作成
  - 処理状況表示の拡張（LLM処理中インジケータ）を実装
  - _Requirements: 5.1, 5.3, 6.2_

- [x] 6.2 バックエンドAPIエンドポイントの拡張
  - LLMパラメータを含むリクエスト処理を実装
  - プロンプトファイルアップロードAPIを追加
  - LLM判定結果の特別なレスポンス形式対応を実装
  - Web UIからのLLMリクエストハンドリングを構築
  - _Requirements: 5.2, 5.5_

- [ ] 7. 設定ファイル管理システムの実装
- [ ] 7.1 設定ファイル管理機能の構築
  - LLM設定ファイルの自動生成機能を実装
  - 設定ファイルの読み込みとマージロジックを構築
  - 環境変数、CLIオプション、設定ファイルの優先順位制御を実装
  - 設定バリデーションとエラーレポート機能を追加
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 7.2 設定の永続化とエクスポート機能の実装
  - 現在の設定を設定ファイルに保存する機能を実装
  - 設定のインポート/エクスポート機能を構築
  - デフォルト設定へのリセット機能を追加
  - 設定プロファイルの管理機能を実装
  - _Requirements: 7.5_

- [ ] 8. パフォーマンス監視とメトリクス機能
- [ ] 8.1 メトリクス収集とログ記録の実装
  - API呼び出し応答時間の記録機能を実装
  - エラー率とフォールバック使用率の統計機能を構築
  - モデル別の成功率追跡機能を実装
  - 構造化ログへのLLM関連イベント記録を追加
  - _Requirements: 6.1_

- [ ] 8.2 キャッシングとリソース管理の実装
  - プロンプトテンプレートのキャッシュ機能を実装
  - API接続プールの管理と最適化を構築
  - メモリ使用量の監視とクリーンアップ機能を追加
  - 大規模バッチ処理での効率化機能を実装
  - _Requirements: 6.5_

- [ ] 9. 包括的なテストスイートの実装
- [ ] 9.1 ユニットテストの作成
  - LLMクライアント通信機能のテストを実装
  - プロンプトテンプレート処理のテストを作成
  - スコア変換ロジックのテストケースを実装
  - エラーハンドリングとフォールバックのテストを作成
  - _Requirements: 全機能の品質保証_

- [ ] 9.2 統合テストとE2Eテストの実装
  - CLI統合テスト（LLMフラグ付き実行）を実装
  - API統合テスト（LLMパラメータ付きリクエスト）を作成
  - Playwright MCPを使用したWeb UIテストシナリオを実装
  - エラーシナリオと回復処理のテストを作成
  - _Requirements: 全機能の品質保証_

- [ ] 10. 最終統合とシステム検証
- [ ] 10.1 全機能の統合確認
  - すべてのインターフェースでのLLM機能動作確認を実施
  - 既存機能との互換性テストを実行
  - エンドツーエンドのワークフロー検証を実施
  - ドキュメントとヘルプテキストの最終更新を実行
  - _Requirements: 全要件の統合確認_