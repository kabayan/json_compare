# Implementation Plan

## 実装タスクリスト

- [x] 1. プロンプトテンプレート管理基盤の構築
- [x] 1.1 YAMLベースのプロンプト管理システムの実装
  - プロンプトテンプレートファイルの読み込み機能を実装
  - YAMLファイルのパースとバリデーション処理を追加
  - テンプレート内の変数置換メカニズムを構築
  - デフォルトプロンプトファイルの作成と配置
  - _Requirements: 2.1, 2.2, 2.4, 2.5_

- [x] 1.2 プロンプトテンプレート設定構造の確立
  - プロンプトファイルのディレクトリ構造を定義
  - デフォルト類似度判定プロンプトテンプレートを作成
  - システムプロンプトとユーザープロンプトの分離管理
  - プロンプトバージョン管理の仕組みを追加
  - _Requirements: 2.1, 2.3_

- [x] 2. vLLM API通信クライアントの実装
- [x] 2.1 HTTPクライアント基盤の構築
  - httpxを使用した非同期HTTP通信の実装
  - vLLM APIエンドポイントへの接続設定
  - 認証ヘッダーとリクエストフォーマットの実装
  - 環境変数によるAPIエンドポイントの設定機能
  - _Requirements: 1.3, 3.5, 6.1_

- [x] 2.2 APIレスポンス処理とエラーハンドリング
  - APIレスポンスのパースと検証処理
  - タイムアウト処理とプログレスバー表示の実装
  - 接続エラー時のリトライメカニズム構築
  - レート制限エラーへの指数バックオフ対応
  - _Requirements: 1.4, 1.5, 6.2, 6.3, 6.4_

- [x] 3. LLMベース類似度判定コアロジックの実装
- [x] 3.1 類似度計算エンジンの構築
  - LLMを使用した類似度判定メインロジックの実装
  - 比較対象テキストのプロンプトへの埋め込み処理
  - モデル選択とパラメータ設定機能の実装
  - バッチ処理での順次実行メカニズム
  - _Requirements: 1.1, 3.1, 3.2, 3.3, 3.4, 6.5_

- [x] 3.2 スコア変換と結果処理システム
  - LLM応答から数値スコアを抽出する機能
  - カテゴリベースのスコア推定ロジックの実装
  - 解析不能な応答への対処メカニズム
  - 各行の処理結果とスコアのログ記録機能
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 4. 既存システムへの統合と戦略パターン実装
- [x] 4.1 類似度計算戦略の切り替えメカニズム
  - Strategyパターンによる計算方式の選択機能
  - 埋め込みモードとLLMモードの動的切り替え
  - 既存の類似度計算インターフェースとの統合
  - フォールバック機能の実装と自動切り替えロジック
  - _Requirements: 1.1, 1.2, 1.4, 6.3_

- [x] 4.2 メタデータ管理と結果フォーマット拡張
  - 使用した判定方式の情報を結果に含める機能
  - LLM固有のメタデータ（モデル名、プロンプト情報）の追加
  - 処理時間とパフォーマンスメトリクスの記録
  - 既存の出力フォーマットとの互換性維持
  - _Requirements: 5.5, 6.1_

- [x] 5. CLIインターフェースの拡張
- [x] 5.1 コマンドラインオプションの追加
  - LLMモード有効化フラグの実装
  - プロンプトファイル指定オプションの追加
  - モデル選択と生成パラメータのオプション実装
  - デュアルファイル比較でのLLMサポート追加
  - _Requirements: 1.1, 2.2, 3.2, 5.4_

- [x] 5.2 CLIヘルプとエラーメッセージの更新
  - 新規オプションのヘルプメッセージ追加
  - LLM関連エラーの詳細な表示機能
  - フォールバック提案メッセージの実装
  - 使用例とベストプラクティスの文書化
  - _Requirements: 1.4, 2.3_

- [x] 6. Web UIへのLLM機能統合
- [x] 6.1 フロントエンドUIコンポーネントの追加
  - LLMベース判定使用チェックボックスの実装
  - プロンプトファイル選択インターフェースの構築
  - LLMモード時の追加設定フォームの作成
  - 処理状況表示の拡張（LLM処理中インジケータ）
  - _Requirements: 5.1, 5.3, 6.2_

- [x] 6.2 バックエンドAPIエンドポイントの拡張
  - LLMパラメータを含むリクエスト処理の実装
  - プロンプトファイルアップロードAPIの追加
  - LLM判定結果の特別なレスポンス形式対応
  - _Requirements: 5.2, 5.5_

- [x] 7. 設定ファイル管理システムの実装
- [x] 7.1 YAML設定ファイルの管理機能
  - LLM設定ファイルの自動生成機能
  - 設定ファイルの読み込みとマージロジック
  - 環境変数、CLIオプション、設定ファイルの優先順位制御
  - 設定バリデーションとエラーレポート機能
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 7.2 設定の永続化とエクスポート機能
  - 現在の設定を設定ファイルに保存する機能
  - 設定のインポート/エクスポート機能
  - デフォルト設定へのリセット機能
  - 設定プロファイルの管理機能（開発/本番など）
  - _Requirements: 7.5_

- [x] 8. 包括的なテストスイートの実装
- [x] 8.1 ユニットテストの作成
  - LLMクライアントのモック化とテスト
  - プロンプトテンプレート処理のテスト
  - スコア変換ロジックのテストケース作成
  - エラーハンドリングとフォールバックのテスト
  - _Requirements: 全般的な品質保証_

- [x] 8.2 統合テストとE2Eテストの実装
  - CLI統合テスト（LLMフラグ付き実行）
  - API統合テスト（LLMパラメータ付きリクエスト）
  - Playwright MCPを使用したWeb UIテストシナリオ
  - エラーシナリオと回復処理のテスト
  - _Requirements: 全般的な品質保証_

- [x] 9. パフォーマンス最適化とモニタリング
- [x] 9.1 メトリクス収集とログ記録の強化
  - API呼び出し応答時間の記録機能
  - エラー率とフォールバック使用率の統計
  - モデル別の成功率追跡機能
  - 構造化ログへのLLM関連イベント記録
  - _Requirements: 6.1_

- [x] 9.2 キャッシングとリソース管理
  - プロンプトテンプレートのキャッシュ機能
  - API接続プールの管理と最適化
  - メモリ使用量の監視とクリーンアップ
  - 大規模バッチ処理での効率化
  - _Requirements: 6.5_

- [x] 10. 最終統合とシステムテスト
- [x] 10.1 全機能の統合確認
  - すべてのインターフェースでのLLM機能動作確認
  - 既存機能との互換性テスト
  - エンドツーエンドのワークフロー検証
  - ドキュメントとヘルプテキストの最終更新
  - _Requirements: 全要件の統合確認_