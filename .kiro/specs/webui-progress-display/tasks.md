# Implementation Plan

## 実装タスク

- [x] 1. 進捗トラッキング基盤の構築
- [x] 1.1 進捗管理システムの中核機能を実装
  - タスクIDによる処理の一意識別機能を作成
  - 処理開始時刻と全体件数を記録する仕組みを構築
  - インメモリでの進捗データ管理構造を実装
  - タスクの状態遷移（開始・処理中・完了・エラー）を管理
  - 進捗データの取得と更新のインターフェースを定義
  - _Requirements: 1.1, 1.5_

- [x] 1.2 時間計算と推定機能を実装
  - 処理開始からの経過時間を計算する機能を作成
  - 現在の処理速度を移動平均で算出する仕組みを構築
  - 残り時間を処理速度から推定する計算ロジックを実装
  - 処理速度が遅い場合の警告判定機能を追加
  - _Requirements: 1.2, 3.1, 3.2, 3.5_

- [x] 2. tqdm出力のキャプチャ機構の実装
- [x] 2.1 tqdm出力のインターセプト機能を構築
  - コンソール出力を一時的にリダイレクトする仕組みを作成
  - tqdmのプログレスバー出力をキャプチャする機能を実装
  - キャプチャした出力を元のコンソールにも表示する処理を追加
  - 処理終了時にリダイレクトを正しく復元する機能を実装
  - _Requirements: 1.3, 6.1_

- [x] 2.2 tqdm出力の解析と進捗データ抽出を実装
  - tqdmの出力文字列から進捗情報を抽出する正規表現パーサーを作成
  - 処理済み件数と全体件数を解析する機能を実装
  - 処理速度やパーセンテージ情報を取得する仕組みを構築
  - 解析したデータを進捗トラッカーに送信する連携処理を実装
  - _Requirements: 1.3, 6.2_

- [x] 3. Server-Sent Events (SSE) 配信機能の実装
- [x] 3.1 SSEストリーミングエンドポイントを構築
  - タスクIDごとのSSE接続を管理する機能を実装
  - 進捗データを1秒ごとにSSEイベントとして送信する仕組みを作成
  - 複数クライアントへの同時配信機能を実装
  - 処理完了時にSSE接続を適切に終了する処理を追加
  - _Requirements: 4.1, 4.2, 4.4, 4.5_

- [x] 3.2 SSE接続の信頼性向上機能を実装
  - クライアント接続の状態監視機能を構築
  - 接続が切断された場合の自動クリーンアップ処理を実装
  - エラー発生時のSSEイベント送信機能を追加
  - タイムアウト時の適切な接続終了処理を実装
  - _Requirements: 4.3, 5.1_

- [x] 4. 非同期処理APIエンドポイントの実装
- [x] 4.1 非同期ファイル比較エンドポイントを作成
  - ファイルアップロードを受け付けてタスクIDを返す機能を実装
  - バックグラウンドでの比較処理開始機能を構築
  - 進捗トラッカーとの連携処理を実装
  - 処理結果の一時保存機能を追加
  - _Requirements: 1.1, 1.4_

- [x] 4.2 進捗状態取得エンドポイントを実装
  - タスクIDから現在の進捗情報を返すAPIを作成
  - 処理完了時に結果データを返す機能を実装
  - エラー情報を含む詳細ステータスを提供する機能を追加
  - タスクが存在しない場合の適切なエラーレスポンスを実装
  - _Requirements: 1.4, 5.3_

- [ ] 5. WebUIフロントエンド機能の実装
- [ ] 5.1 進捗表示UIコンポーネントを構築
  - プログレスバーの表示領域をHTMLに追加
  - パーセンテージと処理件数を表示する要素を作成
  - 経過時間と推定残り時間の表示機能を実装
  - エラーメッセージと警告の表示領域を追加
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 5.2 SSEクライアント機能を実装
  - EventSourceを使用したSSE接続機能を構築
  - 受信した進捗データでUIを更新する処理を実装
  - 接続エラー時の自動再接続機能を追加（最大5回）
  - 処理完了時の結果表示への切り替え機能を実装
  - _Requirements: 3.3, 3.4, 4.3_

- [ ] 5.3 ユーザーインタラクション機能を追加
  - 処理のキャンセルボタンと機能を実装
  - エラー発生時の再試行ボタンを追加
  - 部分結果のダウンロード機能を実装
  - ファイルサイズ超過時の分割提案表示を追加
  - _Requirements: 5.2, 5.4, 5.5_

- [ ] 6. 既存システムとの統合
- [ ] 6.1 ログシステムとの連携を実装
  - 進捗情報をログエントリとして記録する機能を追加
  - エラー発生時の詳細ログ記録を実装
  - メトリクス収集機能との統合処理を追加
  - ログローテーションへの対応を確認
  - _Requirements: 6.3, 6.4, 6.5_

- [ ] 6.2 既存のWeb UIとAPIの改修
  - 現在の同期処理エンドポイントとの互換性を維持
  - ファイルアップロードフォームの非同期対応を実装
  - 進捗表示エリアのレイアウト調整を行う
  - 既存のエラーハンドリングとの統合を実装
  - _Requirements: 2.1, 6.5_

- [ ] 7. テストの実装
- [ ] 7.1 バックエンド機能のユニットテストを作成
  - 進捗トラッカーの各メソッドのテストを実装
  - tqdm出力パーサーの正確性テストを作成
  - 時間計算と推定ロジックのテストを追加
  - エラーハンドリングのテストケースを実装
  - _Requirements: すべての機能要件_

- [ ] 7.2 統合テストとE2Eテストを実装
  - SSEストリーミングの動作確認テストを作成
  - ファイルアップロードから完了までの一連のフローテストを実装
  - 複数クライアント同時接続のテストを追加
  - エラー発生時の復旧フローのテストを作成
  - _Requirements: 4.4, 5.1, 5.3, 5.4_