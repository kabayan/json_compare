# Requirements Document

## 概要
JSON Compare WebUIに、処理の進捗状況をリアルタイムで表示する機能を追加します。現在はコンソールログでのみ確認可能な進捗情報（処理済み件数、経過時間、推定残り時間）をWebUI上で直接確認できるようにし、ユーザーエクスペリエンスを向上させます。既存のログ機能とtqdmプログレスバーの情報を活用し、シンプルかつ効果的な実装を目指します。

## Requirements

### Requirement 1: 進捗情報の取得とトラッキング
**目的:** WebUIユーザーとして、処理の進捗状況をリアルタイムで確認したい。処理がどの程度完了し、いつ頃終了するかを把握することで、待ち時間を有効に使えるようにする。

#### 受け入れ基準

1. WHEN 比較処理が開始された THEN FastAPIサーバー SHALL 処理開始時刻とタスクIDを記録する
2. WHILE 比較処理が実行中である THE システム SHALL 1秒ごとに処理済み件数を更新する
3. WHERE tqdmプログレスバーがログ出力を行う THE システム SHALL その進捗情報をキャプチャして内部データ構造に保存する
4. IF 処理中にエラーが発生した THEN システム SHALL エラー情報を進捗データに記録し、処理を停止する
5. WHEN 処理が完了した THEN システム SHALL 最終的な処理件数と完了時刻を記録する

### Requirement 2: WebUIでの進捗表示
**目的:** WebUIユーザーとして、アップロードしたファイルの処理進捗を視覚的に確認したい。プログレスバー、パーセンテージ、時間情報を見やすく表示してほしい。

#### 受け入れ基準

1. WHEN ユーザーがファイルをアップロードして処理を開始した THEN WebUI SHALL 進捗表示エリアを表示する
2. WHILE 処理が実行中である THE WebUI SHALL プログレスバーを0%から100%まで更新する
3. IF 処理済み件数が更新された THEN WebUI SHALL パーセンテージ表示を再計算して更新する
4. WHERE 進捗表示エリアが表示されている THE WebUI SHALL 処理済み件数/全件数の形式で件数を表示する
5. WHEN 処理時間が1秒経過するごと THEN WebUI SHALL 経過時間を「HH:MM:SS」形式で更新する

### Requirement 3: 推定残り時間の計算と表示
**目的:** WebUIユーザーとして、処理がいつ頃完了するかの目安を知りたい。現在の処理速度から推定される残り時間を確認できるようにする。

#### 受け入れ基準

1. WHEN 処理が10%以上完了した THEN システム SHALL 平均処理速度から残り時間を計算する
2. IF 処理速度が変動した THEN システム SHALL 移動平均を用いて残り時間を再計算する
3. WHERE 残り時間が計算可能な状態である THE WebUI SHALL 「残り約XX分XX秒」の形式で表示する
4. IF 残り時間が1分未満である THEN WebUI SHALL 「まもなく完了」と表示する
5. WHEN 処理速度が極端に遅い（1件/秒未満） THEN WebUI SHALL 警告メッセージを表示する

### Requirement 4: リアルタイム更新機構
**目的:** WebUIユーザーとして、ページをリロードすることなく最新の進捗情報を確認したい。サーバーからの更新を自動的に受け取りたい。

#### 受け入れ基準

1. WHEN 処理が開始された THEN WebUI SHALL Server-Sent Events (SSE) またはWebSocket接続を確立する
2. WHILE SSE/WebSocket接続がアクティブである THE サーバー SHALL 1秒ごとに進捗データを送信する
3. IF ネットワーク接続が切断された THEN WebUI SHALL 自動的に再接続を試みる（最大5回）
4. WHERE 複数のタブ/ウィンドウで同じ処理を監視している THE システム SHALL 全てのクライアントに同じ進捗情報を配信する
5. WHEN 処理が完了または中断された THEN サーバー SHALL 最終ステータスを送信してSSE/WebSocket接続を終了する

### Requirement 5: エラーハンドリングとユーザーフィードバック
**目的:** WebUIユーザーとして、処理中に問題が発生した場合に適切な情報を受け取りたい。エラーの内容と対処方法を理解できるようにする。

#### 受け入れ基準

1. WHEN タイムアウトが発生した THEN WebUI SHALL 「処理がタイムアウトしました」というメッセージと再試行ボタンを表示する
2. IF メモリ不足エラーが発生した THEN WebUI SHALL ファイルサイズ削減の提案メッセージを表示する
3. WHERE エラーが発生した THE WebUI SHALL エラー発生時点の進捗状況を保持して表示する
4. WHEN ユーザーが処理をキャンセルした THEN システム SHALL 処理を安全に停止してキャンセル完了を通知する
5. IF 部分的な処理結果が利用可能である THEN WebUI SHALL 処理済み部分のダウンロードオプションを提供する

### Requirement 6: 既存機能との統合
**目的:** 開発者として、既存のログ機能やtqdm出力を最大限活用したい。コードの重複を避け、保守性の高い実装を実現する。

#### 受け入れ基準

1. WHERE tqdmがコンソールに出力する THE システム SHALL その出力をインターセプトして進捗データを抽出する
2. WHEN ログエントリが記録された AND 進捗情報を含む THEN システム SHALL その情報を進捗トラッキングに利用する
3. IF 既存のメトリクス収集機能が有効である THEN システム SHALL 進捗データをメトリクスとして記録する
4. WHERE エラーログが出力される THE システム SHALL エラー内容を進捗表示に反映する
5. WHEN 処理が完了した THEN システム SHALL 既存のログローテーション機能に従って進捗ログを保存する